{% extends "base.html" %}

{% block title %}Organization Details - Depanku{% endblock %}

{% block content %}
<div id="loading-container" class="text-center" style="padding: 8rem 0;">
    <div class="loading-spinner"></div>
    <p class="mt-3 text-muted">Loading Organization...</p>
</div>

<div id="org-content" style="display: none;">
    <header class="org-header">
        <div class="container">
            <img src="{{ url_for('static', filename='images/default-org.png') }}" alt="Organization Logo" id="orgLogo"
                class="org-logo">
            <h1 id="orgName"></h1>
            <div id="orgMeta" class="tags-container" style="justify-content: center; gap: 1rem;"></div>
        </div>
    </header>

    <main class="container">
        <div class="org-view-grid">
            <div class="main-content">
                <div class="card">
                    <div class="card-header">
                        <h4>About This Organization</h4>
                    </div>
                    <div class="card-body">
                        <p id="orgDescription" style="white-space: pre-wrap;"></p>
                        <div id="orgTags" class="tags-container mt-4"></div>
                    </div>
                </div>
                <div class="card" id="positionsCard" style="display: none;">
                    <div class="card-header">
                        <h4>Open Positions</h4>
                    </div>
                    <div class="card-body" id="positionsList"></div>
                </div>
            </div>
            <aside class="sidebar-content">
                <div class="card" id="ownerActions" style="display: none;">
                    <div class="card-header">
                        <h4>Manage</h4>
                    </div>
                    <div class="card-body d-grid gap-2">
                        <a href="#" class="btn btn-primary" id="editBtn">Edit Organization</a>
                        <button class="btn btn-danger" id="deleteBtn">Delete Organization</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4>Contact & Links</h4>
                    </div>
                    <div class="card-body">
                        <p><strong>Website:</strong><br><a href="#" id="orgWebsite" target="_blank"
                                rel="noopener noreferrer">Not Provided</a></p>
                        <p><strong>Email:</strong><br><a href="#" id="orgEmail">Not Provided</a></p>
                        <div id="orgAddressContainer" style="display: none;">
                            <p><strong>Address:</strong><br><span id="orgAddress"></span></p>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>
</div>

<!-- Delete Confirmation Modal (Using simple confirm() for brevity, Bootstrap modal is also a good choice) -->
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const orgId = '{{ org_id }}';
        const loadingEl = document.getElementById('loading-container');
        const contentEl = document.getElementById('org-content');
        let organizationData = null;

        try {
            const response = await fetch(`/api/organizations/${orgId}`);
            if (!response.ok) throw new Error('Organization not found.');

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            organizationData = result.data;
            document.title = `${organizationData.name} - Depanku`;
            populatePage(organizationData);
            checkOwnership(organizationData);

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

        } catch (error) {
            loadingEl.innerHTML = `<div class="container"><div class="alert alert-danger">Error: ${error.message}</div></div>`;
        }

        function populatePage(org) {
            document.getElementById('orgName').textContent = org.name;
            document.getElementById('orgDescription').textContent = org.description;
            if (org.logo) { document.getElementById('orgLogo').src = org.logo; }
            else { document.getElementById('orgLogo').src = "{{ url_for('static', filename='images/default-org.png') }}"; }

            // Meta tags
            const metaContainer = document.getElementById('orgMeta');
            metaContainer.innerHTML = `
            <span class="tag">${org.category || 'N/A'}</span>
            <span class="tag">${org.location?.type || 'N/A'}</span>
            <span class="tag ${org.status === 'approved' ? 'bg-success text-white' : 'bg-warning text-dark'}">${org.status}</span>
        `;

            // Tags
            const tagsContainer = document.getElementById('orgTags');
            tagsContainer.innerHTML = org.tags?.length ? org.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : `<span class="text-muted small">No tags provided.</span>`;

            // Contact info
            if (org.website) { document.getElementById('orgWebsite').href = org.website; document.getElementById('orgWebsite').textContent = org.website; }
            if (org.contactEmail) { document.getElementById('orgEmail').href = 'mailto:' + org.contactEmail; document.getElementById('orgEmail').textContent = org.contactEmail; }
            if (org.location?.address) {
                document.getElementById('orgAddressContainer').style.display = 'block';
                document.getElementById('orgAddress').textContent = org.location.address;
            }

            // Positions
            const positionsContainer = document.getElementById('positionsList');
            if (org.openPositions?.length) {
                document.getElementById('positionsCard').style.display = 'block';
                positionsContainer.innerHTML = org.openPositions.map(pos => `
                <div class="position-card">
                    <h5>${pos.title}</h5>
                    <p class="text-muted mb-2">${pos.description || ''}</p>
                    ${pos.requirements?.length ? `<p class="mb-2"><strong>Requirements:</strong> ${pos.requirements.join(', ')}</p>` : ''}
                    ${pos.applicationLink ? `<a href="${pos.applicationLink}" class="btn btn-sm btn-primary" target="_blank">Apply Now</a>` : ''}
                </div>
            `).join('');
            }
        }

        async function checkOwnership(org) {
            const user = await window.authHandlers.getCurrentUser();
            // The API already strips ownerId if not authorized, so checking for its existence is a reliable way to verify ownership.
            if (user && org.ownerId && user.uid === org.ownerId) {
                document.getElementById('ownerActions').style.display = 'block';
                document.getElementById('editBtn').href = `/organizations/${orgId}/edit`;
                document.getElementById('deleteBtn').addEventListener('click', handleDelete);
            }
        }

        async function handleDelete() {
            if (confirm('Are you sure you want to permanently delete this organization? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/organizations/${orgId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Deletion failed.');
                    alert('Organization deleted successfully.');
                    window.location.href = "{{ url_for('organizations.organizations_page') }}";
                } catch (err) {
                    alert('Failed to delete organization. Please try again.');
                }
            }
        }
    });
</script>
{% endblock %}