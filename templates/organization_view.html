{% extends "base.html" %}

{% block title %}{{ organization_name|default('Organization Details') }} - Depanku{% endblock %}
{% block og_title %}{{ organization_name|default('Organization Details') }} - Depanku{% endblock %}
{% block og_description %}{{ organization_description|default('Discover opportunities and learn more about this organization on Depanku.') }}{% endblock %}
{% block twitter_title %}{{ organization_name|default('Organization Details') }} - Depanku{% endblock %}
{% block twitter_description %}{{ organization_description|default('Discover opportunities and learn more about this organization on Depanku.') }}{% endblock %}

{% block content %}
<main class="organization-view-page" id="main-content">
    <!-- Skip Navigation Link -->
    <a href="#organization-details" class="skip-link">Skip to organization details</a>

    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="breadcrumb-nav">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}" aria-label="Home">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('organizations.organizations_page') }}" aria-label="Organizations">Organizations</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ organization_name|default('Organization Details') }}</li>
        </ol>
    </nav>

    <!-- Loading State -->
    <div id="loading-container" class="loading-container" role="status" aria-live="polite">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading Organization Details...</p>
    </div>

    <!-- Organization Content -->
    <div id="org-content" style="display: none;">
        <!-- Organization Header -->
        <header class="org-header" role="banner">
            <div class="container">
                <div class="org-header-content">
                    <div class="org-logo-container">
                        <img src="{{ url_for('static', filename='images/default-org.png') }}" 
                             alt="Organization Logo" 
                             id="orgLogo"
                             class="org-logo"
                             loading="lazy">
                    </div>
                    <div class="org-info">
                        <h1 id="orgName" class="org-name">{{ organization_name|default('Organization Name') }}</h1>
                        <div id="orgMeta" class="org-meta" role="status" aria-live="polite">
                            <!-- Meta information will be populated by JavaScript -->
                        </div>
                        <div class="org-actions" id="orgActions">
                            <!-- Action buttons will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="organization-main" id="organization-details">
            <div class="container">
                <div class="org-view-grid" role="main">
                    <!-- Primary Content -->
                    <div class="main-content" role="main">
                        <!-- About Section -->
                        <section class="org-section" aria-labelledby="about-heading">
                            <div class="section-header">
                                <h2 id="about-heading" class="section-title">About This Organization</h2>
                                <button type="button" 
                                        class="btn btn-icon btn-sm" 
                                        id="share-org-btn"
                                        aria-label="Share organization details"
                                        title="Share this organization">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="18" cy="5" r="3"></circle>
                                        <circle cx="6" cy="12" r="3"></circle>
                                        <circle cx="18" cy="19" r="3"></circle>
                                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                    </svg>
                                </button>
                            </div>
                            <div class="section-content">
                                <div class="org-description">
                                    <p id="orgDescription" class="description-text">{{ organization_description|default('No description available.') }}</p>
                                </div>
                                <div class="org-tags" id="orgTags" aria-label="Organization tags">
                                    <!-- Tags will be populated by JavaScript -->
                                </div>
                            </div>
                        </section>

                        <!-- Open Positions Section -->
                        <section class="org-section" aria-labelledby="positions-heading" id="positionsSection">
                            <div class="section-header">
                                <h2 id="positions-heading" class="section-title">Open Positions</h2>
                                <span class="position-count" id="positionCount" aria-label="Number of open positions"></span>
                            </div>
                            <div class="section-content">
                                <div id="positionsList" class="positions-list" role="list">
                                    <!-- Positions will be populated by JavaScript -->
                                </div>
                                <div id="noPositions" class="no-positions" style="display: none;">
                                    <p class="text-muted">No open positions at this time.</p>
                                    <p class="text-muted small">Check back later for new opportunities!</p>
                                </div>
                            </div>
                        </section>

                        <!-- Organization Details Section -->
                        <section class="org-section" aria-labelledby="details-heading">
                            <div class="section-header">
                                <h2 id="details-heading" class="section-title">Organization Details</h2>
                            </div>
                            <div class="section-content">
                                <div class="org-details-grid">
                                    <div class="detail-item">
                                        <h4 class="detail-label">Founded</h4>
                                        <p class="detail-value" id="orgFounded">Not specified</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4 class="detail-label">Size</h4>
                                        <p class="detail-value" id="orgSize">Not specified</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4 class="detail-label">Industry</h4>
                                        <p class="detail-value" id="orgIndustry">Not specified</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4 class="detail-label">Status</h4>
                                        <p class="detail-value" id="orgStatus">Not specified</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Testimonials Section -->
                        <section class="org-section" aria-labelledby="testimonials-heading">
                            <div class="section-header">
                                <h2 id="testimonials-heading" class="section-title">Student Experiences</h2>
                            </div>
                            <div class="section-content">
                                <div id="testimonialsList" class="testimonials-list" role="list">
                                    <!-- Testimonials will be populated by JavaScript -->
                                </div>
                                <div id="noTestimonials" class="no-testimonials" style="display: none;">
                                    <p class="text-muted">No testimonials available yet.</p>
                                    <p class="text-muted small">Be the first to share your experience!</p>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- Sidebar -->
                    <aside class="sidebar-content" role="complementary">
                        <!-- Owner Actions -->
                        <div class="sidebar-card" id="ownerActions" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title">Manage Organization</h3>
                            </div>
                            <div class="card-body">
                                <div class="action-buttons">
                                    <a href="#" class="btn btn-primary" id="editBtn" aria-label="Edit organization details">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Edit Organization
                                    </a>
                                    <button type="button" class="btn btn-danger" id="deleteBtn" aria-label="Delete organization">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        Delete Organization
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Contact & Links -->
                        <div class="sidebar-card">
                            <div class="card-header">
                                <h3 class="card-title">Contact & Links</h3>
                            </div>
                            <div class="card-body">
                                <div class="contact-info">
                                    <div class="contact-item">
                                        <h4 class="contact-label">Website</h4>
                                        <a href="#" id="orgWebsite" target="_blank" rel="noopener noreferrer" class="contact-link">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                            </svg>
                                            <span id="orgWebsiteText">Not Provided</span>
                                        </a>
                                    </div>
                                    <div class="contact-item">
                                        <h4 class="contact-label">Email</h4>
                                        <a href="#" id="orgEmail" class="contact-link">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                                <polyline points="22,6 12,13 2,6"></polyline>
                                            </svg>
                                            <span id="orgEmailText">Not Provided</span>
                                        </a>
                                    </div>
                                    <div class="contact-item" id="orgAddressContainer" style="display: none;">
                                        <h4 class="contact-label">Address</h4>
                                        <div class="contact-address">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                                <circle cx="12" cy="10" r="3"></circle>
                                            </svg>
                                            <span id="orgAddress"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="sidebar-card">
                            <div class="card-header">
                                <h3 class="card-title">Quick Stats</h3>
                            </div>
                            <div class="card-body">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-value" id="statApplications">0</div>
                                        <div class="stat-label">Applications</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" id="statHires">0</div>
                                        <div class="stat-label">Hires</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" id="statRating">0.0</div>
                                        <div class="stat-label">Rating</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Related Organizations -->
                        <div class="sidebar-card">
                            <div class="card-header">
                                <h3 class="card-title">Similar Organizations</h3>
                            </div>
                            <div class="card-body">
                                <div id="relatedOrgs" class="related-orgs">
                                    <!-- Related organizations will be populated by JavaScript -->
                                </div>
                                <div id="noRelatedOrgs" class="no-related-orgs" style="display: none;">
                                    <p class="text-muted">No similar organizations found.</p>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete Organization</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close delete confirmation"></button>
                </div>
                <div class="modal-body">
                    <div class="delete-warning">
                        <div class="warning-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </div>
                        <div class="warning-content">
                            <h6>Are you sure you want to delete this organization?</h6>
                            <p>This action cannot be undone. All organization data, including positions and applications, will be permanently removed.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Organization</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Share Organization</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close share modal"></button>
                </div>
                <div class="modal-body">
                    <div class="share-options">
                        <div class="share-option">
                            <button type="button" class="btn btn-outline btn-block" id="copyLinkBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                Copy Link
                            </button>
                        </div>
                        <div class="share-option">
                            <button type="button" class="btn btn-outline btn-block" id="shareEmailBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                    <polyline points="22,6 12,13 2,6"></polyline>
                                </svg>
                                Share via Email
                            </button>
                        </div>
                        <div class="share-option">
                            <button type="button" class="btn btn-outline btn-block" id="shareSocialBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                                </svg>
                                Share on Social Media
                            </button>
                        </div>
                    </div>
                    <div class="share-link" style="display: none;">
                        <label for="shareUrlInput" class="form-label">Share Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareUrlInput" readonly>
                            <button type="button" class="btn btn-outline" id="copyShareLinkBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Structured Data for Organization View -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "{{ organization_name|default('Organization Name') }}",
    "description": "{{ organization_description|default('Organization description not available.') }}",
    "url": "{{ canonical_url|default('https://depanku.com' + request.path) }}",
    {% if organization_logo %}
    "logo": "{{ organization_logo }}",
    {% endif %}
    {% if organization_website %}
    "sameAs": ["{{ organization_website }}"],
    {% endif %}
    "address": {
        "@type": "PostalAddress",
        {% if organization_address %}
        "streetAddress": "{{ organization_address.street }}",
        "addressLocality": "{{ organization_address.city }}",
        "addressRegion": "{{ organization_address.state }}",
        "postalCode": "{{ organization_address.zip }}",
        "addressCountry": "{{ organization_address.country }}"
        {% endif %}
    },
    "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "general",
        {% if organization_email %}
        "email": "{{ organization_email }}"
        {% endif %}
    },
    "jobOpening": {
        "@type": "JobPosting",
        "title": "Sample Position",
        "description": "Sample job description",
        "datePosted": "2024-01-01",
        "employmentType": "INTERN",
        "hiringOrganization": {
            "@type": "Organization",
            "name": "{{ organization_name|default('Organization Name') }}"
        }
    }
}
</script>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const orgId = '{{ org_id }}';
        const loadingEl = document.getElementById('loading-container');
        const contentEl = document.getElementById('org-content');
        let organizationData = null;
        
        // Initialize modals
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
        
        // ARIA Live Region for Dynamic Updates
        const ariaLiveRegion = document.createElement('div');
        ariaLiveRegion.className = 'sr-only';
        ariaLiveRegion.setAttribute('aria-live', 'polite');
        ariaLiveRegion.setAttribute('aria-atomic', 'true');
        document.body.appendChild(ariaLiveRegion);
        
        function announceToScreenReader(message) {
            ariaLiveRegion.textContent = message;
            setTimeout(() => {
                ariaLiveRegion.textContent = '';
            }, 1000);
        }
        
        try {
            const response = await fetch(`/api/organizations/${orgId}`);
            if (!response.ok) throw new Error('Organization not found.');
            
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            
            organizationData = result.data;
            document.title = `${organizationData.name} - Depanku`;
            populatePage(organizationData);
            checkOwnership(organizationData);
            loadRelatedOrganizations(organizationData);
            
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
            
            announceToScreenReader(`Organization ${organizationData.name} loaded successfully`);
            
        } catch (error) {
            loadingEl.innerHTML = `
                <div class="container">
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-title">Error Loading Organization</h4>
                        <p class="alert-message">${error.message}</p>
                        <a href="{{ url_for('organizations.organizations_page') }}" class="btn btn-outline">Back to Organizations</a>
                    </div>
                </div>
            `;
            announceToScreenReader(`Error: ${error.message}`);
        }
        
        function populatePage(org) {
            // Organization name and logo
            document.getElementById('orgName').textContent = org.name;
            const orgLogo = document.getElementById('orgLogo');
            if (org.logo) {
                orgLogo.src = org.logo;
                orgLogo.alt = `${org.name} logo`;
            }
            
            // Meta information
            const metaContainer = document.getElementById('orgMeta');
            metaContainer.innerHTML = `
                <span class="meta-tag category-tag">${org.category || 'N/A'}</span>
                <span class="meta-tag location-tag">${org.location?.type || 'N/A'}</span>
                <span class="meta-tag status-tag ${org.status === 'approved' ? 'status-approved' : 'status-pending'}">${org.status}</span>
            `;
            
            // Description
            document.getElementById('orgDescription').textContent = org.description || 'No description available.';
            
            // Tags
            const tagsContainer = document.getElementById('orgTags');
            if (org.tags && org.tags.length) {
                tagsContainer.innerHTML = org.tags.map(tag => 
                    `<span class="tag" role="button" tabindex="0" aria-label="Tag: ${tag}">${tag}</span>`
                ).join('');
            } else {
                tagsContainer.innerHTML = '<span class="text-muted small">No tags provided.</span>';
            }
            
            // Contact information
            if (org.website) {
                const websiteLink = document.getElementById('orgWebsite');
                websiteLink.href = org.website;
                websiteLink.textContent = org.website;
                document.getElementById('orgWebsiteText').textContent = org.website;
            }
            
            if (org.contactEmail) {
                const emailLink = document.getElementById('orgEmail');
                emailLink.href = `mailto:${org.contactEmail}`;
                emailLink.textContent = org.contactEmail;
                document.getElementById('orgEmailText').textContent = org.contactEmail;
            }
            
            if (org.location?.address) {
                document.getElementById('orgAddressContainer').style.display = 'block';
                document.getElementById('orgAddress').textContent = org.location.address;
            }
            
            // Organization details
            document.getElementById('orgFounded').textContent = org.founded || 'Not specified';
            document.getElementById('orgSize').textContent = org.size || 'Not specified';
            document.getElementById('orgIndustry').textContent = org.industry || 'Not specified';
            document.getElementById('orgStatus').textContent = org.status || 'Not specified';
            
            // Quick stats
            document.getElementById('statApplications').textContent = org.stats?.applications || 0;
            document.getElementById('statHires').textContent = org.stats?.hires || 0;
            document.getElementById('statRating').textContent = org.stats?.rating || '0.0';
            
            // Positions
            const positionsContainer = document.getElementById('positionsList');
            const noPositions = document.getElementById('noPositions');
            const positionCount = document.getElementById('positionCount');
            
            if (org.openPositions && org.openPositions.length) {
                document.getElementById('positionsSection').style.display = 'block';
                positionCount.textContent = `(${org.openPositions.length})`;
                
                positionsContainer.innerHTML = org.openPositions.map((pos, index) => `
                    <article class="position-card" role="article">
                        <div class="position-header">
                            <h3 class="position-title">${pos.title}</h3>
                            <span class="position-status ${pos.status || 'active'}">${pos.status || 'Active'}</span>
                        </div>
                        <div class="position-content">
                            <p class="position-description">${pos.description || 'No description available.'}</p>
                            ${pos.requirements && pos.requirements.length ? `
                                <div class="position-requirements">
                                    <h4 class="requirements-title">Requirements:</h4>
                                    <ul class="requirements-list">
                                        ${pos.requirements.map(req => `<li>${req}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${pos.applicationLink ? `
                                <div class="position-actions">
                                    <a href="${pos.applicationLink}" class="btn btn-primary" target="_blank" rel="noopener noreferrer" aria-label="Apply for ${pos.title} position">
                                        Apply Now
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </article>
                `).join('');
            } else {
                document.getElementById('positionsSection').style.display = 'none';
                noPositions.style.display = 'block';
            }
            
            // Testimonials
            const testimonialsContainer = document.getElementById('testimonialsList');
            const noTestimonials = document.getElementById('noTestimonials');
            
            if (org.testimonials && org.testimonials.length) {
                testimonialsContainer.innerHTML = org.testimonials.map(testimonial => `
                    <article class="testimonial-card" role="article">
                        <div class="testimonial-header">
                            <div class="testimonial-avatar">
                                <img src="${testimonial.avatar || '/static/images/default-avatar.png'}" 
                                     alt="${testimonial.author} avatar" 
                                     loading="lazy">
                            </div>
                            <div class="testimonial-meta">
                                <h4 class="testimonial-author">${testimonial.author}</h4>
                                <div class="testimonial-rating">
                                    ${generateStars(testimonial.rating)}
                                </div>
                                <time class="testimonial-date" datetime="${testimonial.date}">
                                    ${new Date(testimonial.date).toLocaleDateString()}
                                </time>
                            </div>
                        </div>
                        <div class="testimonial-content">
                            <p class="testimonial-text">"${testimonial.text}"</p>
                            <p class="testimonial-position">${testimonial.position || 'Student'}</p>
                        </div>
                    </article>
                `).join('');
            } else {
                noTestimonials.style.display = 'block';
            }
        }
        
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            }
            
            if (hasHalfStar) {
                stars += '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            }
            
            return stars;
        }
        
        async function checkOwnership(org) {
            const user = await window.authHandlers.getCurrentUser();
            if (user && org.ownerId && user.uid === org.ownerId) {
                document.getElementById('ownerActions').style.display = 'block';
                document.getElementById('editBtn').href = `/organizations/${orgId}/edit`;
                
                // Delete button event
                document.getElementById('deleteBtn').addEventListener('click', () => {
                    deleteModal.show();
                });
                
                // Confirm delete button event
                document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                    try {
                        const response = await fetch(`/api/organizations/${orgId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Deletion failed.');
                        
                        announceToScreenReader('Organization deleted successfully');
                        alert('Organization deleted successfully.');
                        window.location.href = "{{ url_for('organizations.organizations_page') }}";
                    } catch (err) {
                        console.error('Delete error:', err);
                        announceToScreenReader('Failed to delete organization');
                        alert('Failed to delete organization. Please try again.');
                    } finally {
                        deleteModal.hide();
                    }
                });
            }
        }
        
        async function loadRelatedOrganizations(org) {
            try {
                // In a real implementation, this would fetch related organizations
                // For now, we'll show a placeholder
                const relatedContainer = document.getElementById('relatedOrgs');
                const noRelated = document.getElementById('noRelatedOrgs');
                
                // Simulate loading related organizations
                relatedContainer.innerHTML = `
                    <div class="related-org-item">
                        <img src="/static/images/default-org.png" alt="Related organization" loading="lazy">
                        <div class="related-org-info">
                            <h4>Related Organization 1</h4>
                            <p class="text-muted">Similar organization in the same industry</p>
                        </div>
                    </div>
                    <div class="related-org-item">
                        <img src="/static/images/default-org.png" alt="Related organization" loading="lazy">
                        <div class="related-org-info">
                            <h4>Related Organization 2</h4>
                            <p class="text-muted">Another similar organization</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading related organizations:', error);
                document.getElementById('noRelatedOrgs').style.display = 'block';
            }
        }
        
        // Share functionality
        document.getElementById('share-org-btn').addEventListener('click', () => {
            shareModal.show();
        });
        
        document.getElementById('copyLinkBtn').addEventListener('click', async () => {
            const shareUrl = window.location.href;
            try {
                await navigator.clipboard.writeText(shareUrl);
                announceToScreenReader('Link copied to clipboard');
                alert('Link copied to clipboard!');
            } catch (err) {
                console.error('Copy error:', err);
                announceToScreenReader('Failed to copy link');
                alert('Failed to copy link. Please try again.');
            }
        });
        
        document.getElementById('shareEmailBtn').addEventListener('click', () => {
            const subject = encodeURIComponent(`Check out this organization: ${organizationData.name}`);
            const body = encodeURIComponent(`I found this organization on Depanku that you might be interested in:\n\n${organizationData.name}\n${organizationData.description}\n\nLearn more: ${window.location.href}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });
        
        document.getElementById('shareSocialBtn').addEventListener('click', () => {
            const text = encodeURIComponent(`Check out ${organizationData.name} on Depanku! ${organizationData.description}`);
            const url = encodeURIComponent(window.location.href);
            
            // Open social media share dialogs
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=600,height=400');
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Escape to close modals
            if (e.key === 'Escape') {
                if (deleteModal._isShown) deleteModal.hide();
                if (shareModal._isShown) shareModal.hide();
            }
        });
        
        // Tag keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('tag') && e.key === 'Enter') {
                e.preventDefault();
                // In a real implementation, this might filter or search for the tag
                console.log('Tag clicked:', e.target.textContent);
            }
        });
    });
</script>
{% endblock %}