{% extends "base.html" %}

{% block title %}AI Analysis Results - Depanku{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai_results.css') }}">
{% endblock %}

{% block content %}
<main class="container results-page">
    <div class="back-button mb-4">
        <a href="{{ url_for('ai.ai_analysis_page') }}" class="btn btn-outline">← Start New Analysis</a>
    </div>

    <div id="loading-container" class="loading-container">
        <div class="loading-spinner"></div>
        <p class="mt-2">Loading your analysis results...</p>
    </div>

    <div id="error-container" class="alert alert-danger" style="display: none;"></div>

    <div id="results-content" style="display: none;">
        <div class="results-header">
            <h1>AI Analysis Results</h1>
            <p class="lead text-muted">A detailed breakdown of the multi-AI debate for your goal.</p>
        </div>
        <div class="results-grid">
            <!-- Left Column -->
            <div>
                <div class="section">
                    <h3 class="section-title">Final Recommendation</h3>
                    <div id="consensus-container"></div>
                </div>
                <div class="section">
                    <h3 class="section-title">Goal Refinement Journey</h3>
                    <div id="questions-container"></div>
                </div>
            </div>
            <!-- Right Column -->
            <div>
                <div class="section">
                    <h3 class="section-title">Expert Opinions & Critique</h3>
                    <div id="personas-container"></div>
                    <div id="critique-container"></div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const sessionId = "{{ session_id }}";
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const resultsContainer = document.getElementById('results-content');

        function showError(message) {
            loadingContainer.style.display = 'none';
            errorContainer.textContent = `Error: ${message}`;
            errorContainer.style.display = 'block';
        }

        try {
            const user = await window.authHandlers.getCurrentUser();
            if (!user) {
                window.location.href = `/login?redirect=/ai/results/${sessionId}`;
                return;
            }

            const response = await fetch(`/ai/api/results/${sessionId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Failed to load results.');
            }

            displayResults(data.data);

        } catch (error) {
            showError(error.message);
        }

        function displayResults(session) {
            loadingContainer.style.display = 'none';
            resultsContainer.style.display = 'block';

            // Goal Refinement
            const qContainer = document.getElementById('questions-container');
            if (session.questions && session.userResponses) {
                const refinedGoalHtml = `<div class="persona-card mt-3"><div class="persona-header"><strong class="persona-name">Your Refined Goal:</strong></div><p class="persona-response" style="font-style: italic;">${session.refinedGoal || 'N/A'}</p></div>`;
                qContainer.innerHTML = session.questions.map((q, i) => `
                    <div class="question-item mb-2">
                        <div class="question-text"><strong>Q:</strong> ${q}</div>
                        <div class="response-text text-muted ps-3"><strong>A:</strong> ${session.userResponses[i] || 'No response'}</div>
                    </div>
                `).join('') + refinedGoalHtml;
            }

            // Expert Opinions
            const pContainer = document.getElementById('personas-container');
            const personas = { deepseek: 'Admissions Officer', maverick: 'Student Peer', qwen: 'HR Manager', glm: 'Philosophical Advisor' };
            pContainer.innerHTML = Object.entries(personas).map(([key, name]) => {
                if (session.finalResponses && session.finalResponses[key]) {
                    return `<div class="persona-card ${key}">
                                <div class="persona-header">
                                    <div class="persona-icon">${name.charAt(0)}</div>
                                    <div class="persona-name">${name}</div>
                                </div>
                                <div class="persona-response">${session.finalResponses[key]}</div>
                            </div>`;
                }
                return '';
            }).join('');

            // Critique
            const cContainer = document.getElementById('critique-container');
            if (session.personas && session.personas.grok) {
                cContainer.innerHTML = `<div class="persona-card critique-card">
                                            <div class="persona-header">
                                                <div class="persona-icon">!</div>
                                                <div class="persona-name">Grok (Devil's Advocate)</div>
                                            </div>
                                            <div class="persona-response">${session.personas.grok.critique || ''}</div>
                                        </div>`;
            }

            // Final Recommendation
            const consContainer = document.getElementById('consensus-container');
            if (session.consensus) {
                const consensusTitle = session.consensus.reached ? 'Consensus Reached' : 'Mediated Recommendation';
                consContainer.innerHTML = `<div class="persona-card consensus-card">
                    <div class="persona-header">
                        <div class="persona-icon">✓</div>
                        <div class="persona-name">${consensusTitle}</div>
                    </div>
                    <div class="persona-response"><strong>Recommendation:</strong><br>${session.consensus.finalRecommendation || ''}<br><br><strong>Reasoning:</strong><br>${session.consensus.reasoning || ''}</div>
                </div>`;
            }
        }
    });
</script>
{% endblock %}