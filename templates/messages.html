{% extends "base.html" %}

{% block title %}Messages - Depanku{% endblock %}
{% block og_title %}Messages - Depanku{% endblock %}
{% block og_description %}Manage your conversations and messages with organization owners and other users.{% endblock %}
{% block twitter_title %}Messages - Depanku{% endblock %}
{% block twitter_description %}Manage your conversations and messages with organization owners and other users.{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/messages.css') }}">
{% endblock %}

{% block content %}
<main class="messages-page" id="main-content">
    <!-- Skip Navigation Link -->
    <a href="#conversations-list" class="skip-link">Skip to conversations</a>

    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="breadcrumb-nav">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}" aria-label="Home">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard_page') }}" aria-label="Dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Messages</li>
        </ol>
    </nav>

    <section class="messages-section" aria-labelledby="messages-heading">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="header-content">
                    <h1 id="messages-heading" class="page-title">My Messages</h1>
                    <p class="page-subtitle">Manage your conversations with organization owners and other users.</p>
                </div>
                <div class="header-actions">
                    <button type="button" 
                            class="btn btn-primary" 
                            id="newConversationBtn" 
                            data-bs-toggle="modal"
                            data-bs-target="#newConversationModal"
                            aria-label="Start new conversation">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Message
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-container" class="loading-container" role="status" aria-live="polite">
                <div class="loading-spinner"></div>
                <p class="loading-text">Loading conversations...</p>
            </div>

            <!-- Conversations List -->
            <div id="conversations-container" class="conversations-container" style="display: none;">
                <div class="conversations-header">
                    <h2 id="conversations-list" class="conversations-title">Conversations</h2>
                    <div class="conversations-stats">
                        <span id="conversation-count" class="conversation-count" aria-live="polite">0 conversations</span>
                    </div>
                </div>

                <div class="conversation-list-container" role="list" aria-label="List of conversations">
                    <div id="conversationsList" role="list">
                        <!-- Conversations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state-container" class="empty-state-container" style="display: none;">
                <div class="empty-state-content">
                    <div class="empty-state-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="empty-state-title">No conversations yet</h3>
                    <p class="empty-state-description">Start a new message to get in touch with organization owners.</p>
                    <button type="button" 
                            class="btn btn-primary" 
                            id="empty-state-new-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#newConversationModal">
                        Start Your First Conversation
                    </button>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div id="search-filter-container" class="search-filter-container" style="display: none;">
                <div class="search-filter-content">
                    <div class="search-box">
                        <label for="conversation-search" class="sr-only">Search conversations</label>
                        <input type="text" 
                               id="conversation-search" 
                               class="form-control" 
                               placeholder="Search conversations..."
                               aria-describedby="search-help">
                        <button type="button" class="search-btn" aria-label="Search conversations">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="filter-options">
                        <select id="conversation-filter" class="form-select" aria-label="Filter conversations">
                            <option value="all">All Conversations</option>
                            <option value="unread">Unread Only</option>
                            <option value="unread">Unread Only</option>
                            <option value="sent">Sent by Me</option>
                            <option value="received">Received</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- New Conversation Modal -->
<div class="modal fade" id="newConversationModal" tabindex="-1" aria-labelledby="newConversationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newConversationModalLabel">Start New Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal"></button>
            </div>
            <div class="modal-body">
                <form id="newConversationForm" novalidate>
                    <div class="mb-3">
                        <label for="receiverSelect" class="form-label">To:</label>
                        <select class="form-select" id="receiverSelect" required aria-describedby="receiver-help">
                            <option value="" disabled selected>Choose an organization owner...</option>
                        </select>
                        <div id="receiver-help" class="form-text">Select the organization owner you want to message.</div>
                        <div class="invalid-feedback" id="receiver-error">Please select a recipient.</div>
                    </div>
                    <div class="mb-3">
                        <label for="subjectInput" class="form-label">Subject</label>
                        <input type="text" 
                               class="form-control" 
                               id="subjectInput" 
                               required 
                               maxlength="100"
                               aria-describedby="subject-help"
                               placeholder="Enter a clear subject line">
                        <div id="subject-help" class="form-text">Briefly describe what your message is about.</div>
                        <div class="invalid-feedback" id="subject-error">Please enter a subject.</div>
                    </div>
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" 
                                  id="messageContent" 
                                  rows="4" 
                                  required 
                                  maxlength="1000"
                                  aria-describedby="message-help"
                                  placeholder="Type your message here..."></textarea>
                        <div id="message-help" class="form-text">Be clear and specific about what you're looking for.</div>
                        <div class="invalid-feedback" id="message-error">Please enter your message.</div>
                        <div class="char-counter">
                            <span id="char-count">0</span>/1000 characters
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="newConversationForm" class="btn btn-primary" id="send-message-btn">
                    <span class="btn-text">Send Message</span>
                    <span class="btn-loading" style="display: none;">
                        <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 2v10l7 7"></path>
                        </svg>
                        Sending...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <div class="toast-icon me-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Message sent successfully!
        </div>
    </div>
</div>

<!-- Structured Data for Messaging Interface -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Messages - Depanku",
    "description": "Messaging interface for managing conversations with organization owners",
    "url": "{{ canonical_url|default('https://depanku.com' + request.path) }}",
    "author": {
        "@type": "Organization",
        "name": "Depanku"
    },
    "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "{{ canonical_url|default('https://depanku.com') }}"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Dashboard",
                "item": "{{ canonical_url|default('https://depanku.com/dashboard') }}"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "Messages",
                "item": "{{ canonical_url|default('https://depanku.com' + request.path) }}"
            }
        ]
    },
    "mainEntity": {
        "@type": "MessagingService",
        "name": "Depanku Messaging",
        "description": "Messaging service for connecting students with organization owners",
        "provider": {
            "@type": "Organization",
            "name": "Depanku"
        },
        "availableLanguage": ["English"],
        "featureList": [
            "Real-time messaging",
            "Conversation management",
            "Message search and filtering",
            "New conversation creation"
        ]
    }
}
</script>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/messages.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ARIA Live Region for Dynamic Updates
        const ariaLiveRegion = document.createElement('div');
        ariaLiveRegion.className = 'sr-only';
        ariaLiveRegion.setAttribute('aria-live', 'polite');
        ariaLiveRegion.setAttribute('aria-atomic', 'true');
        document.body.appendChild(ariaLiveRegion);

        function announceToScreenReader(message) {
            ariaLiveRegion.textContent = message;
            setTimeout(() => {
                ariaLiveRegion.textContent = '';
            }, 1000);
        }

        // Character Counter for Message Input
        const messageContent = document.getElementById('messageContent');
        const charCount = document.getElementById('char-count');
        
        messageContent.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
            
            if (count > 900) {
                charCount.parentElement.classList.add('text-warning');
            } else {
                charCount.parentElement.classList.remove('text-warning');
            }
            
            if (count === 1000) {
                announceToScreenReader('Character limit reached');
            }
        });

        // Form Validation
        const newConversationForm = document.getElementById('newConversationForm');
        const receiverSelect = document.getElementById('receiverSelect');
        const subjectInput = document.getElementById('subjectInput');
        const sendBtn = document.getElementById('send-message-btn');

        function validateForm() {
            let isValid = true;

            // Validate receiver
            if (!receiverSelect.value) {
                receiverSelect.classList.add('is-invalid');
                document.getElementById('receiver-error').style.display = 'block';
                isValid = false;
            } else {
                receiverSelect.classList.remove('is-invalid');
                document.getElementById('receiver-error').style.display = 'none';
            }

            // Validate subject
            if (!subjectInput.value.trim()) {
                subjectInput.classList.add('is-invalid');
                document.getElementById('subject-error').style.display = 'block';
                isValid = false;
            } else {
                subjectInput.classList.remove('is-invalid');
                document.getElementById('subject-error').style.display = 'none';
            }

            // Validate message
            if (!messageContent.value.trim()) {
                messageContent.classList.add('is-invalid');
                document.getElementById('message-error').style.display = 'block';
                isValid = false;
            } else {
                messageContent.classList.remove('is-invalid');
                document.getElementById('message-error').style.display = 'none';
            }

            return isValid;
        }

        // Real-time validation
        receiverSelect.addEventListener('change', function() {
            if (this.value) {
                this.classList.remove('is-invalid');
                document.getElementById('receiver-error').style.display = 'none';
            }
        });

        subjectInput.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
                document.getElementById('subject-error').style.display = 'none';
            }
        });

        messageContent.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
                document.getElementById('message-error').style.display = 'none';
            }
        });

        // Form submission
        newConversationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                announceToScreenReader('Please fix the errors in the form');
                return;
            }

            // Show loading state
            sendBtn.disabled = true;
            sendBtn.querySelector('.btn-text').style.display = 'none';
            sendBtn.querySelector('.btn-loading').style.display = 'block';

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Show success toast
                const successToast = new bootstrap.Toast(document.getElementById('success-toast'));
                successToast.show();
                
                // Reset form and close modal
                newConversationForm.reset();
                charCount.textContent = '0';
                bootstrap.Modal.getInstance(document.getElementById('newConversationModal')).hide();
                
                announceToScreenReader('Message sent successfully');
                
                // Reload conversations
                if (window.messagingSystem) {
                    window.messagingSystem.loadConversations();
                }
                
            } catch (error) {
                announceToScreenReader('Failed to send message. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.querySelector('.btn-text').style.display = 'block';
                sendBtn.querySelector('.btn-loading').style.display = 'none';
            }
        });

        // Keyboard navigation support
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('conversation-search');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            
            // Escape to close modal
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(document.getElementById('newConversationModal'));
                if (modal && modal._isShown) {
                    modal.hide();
                }
            }
        });

        // Initialize messaging system
        if (window.messagingSystem) {
            window.messagingSystem.loadConversations();
        }
    });
</script>
{% endblock %}