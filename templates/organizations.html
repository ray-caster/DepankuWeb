{% extends "base.html" %}

{% block title %}Search Organizations - Depanku{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8/themes/satellite-min.css">
{% endblock %}

{% block content %}
<main class="section-padding" style="background-color: var(--light-gray);">
    <div class="container">
        <h1 class="section-title">Discover Organizations</h1>
        <div class="search-container-grid">
            <aside class="filters-panel">
                <div id="category-list"></div>
                <div id="location-list" style="margin-top: 2rem;"></div>
            </aside>
            <div class="results-panel">
                <div id="searchbox"></div>
                <div id="hits"></div>
                <div id="pagination" style="margin-top: 2.5rem;"></div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchClient = algoliasearch('{{ ALGOLIA_APP_ID }}', '{{ ALGOLIA_API_KEY }}');

        const search = instantsearch({
            indexName: 'organizations',
            searchClient,
            initialUiState: {
                organizations: { query: '{{ INITIAL_QUERY | safe }}' },
            },
        });

        search.addWidgets([
            instantsearch.widgets.searchBox({
                container: '#searchbox',
                placeholder: 'Search by keyword, STEM, etc...',
            }),

            instantsearch.widgets.pagination({ container: '#pagination' }),

            instantsearch.widgets.panel({
                templates: { header: '<h4>Category</h4>' }
            })(instantsearch.widgets.refinementList)({
                container: '#category-list',
                attribute: 'category',
            }),

            instantsearch.widgets.panel({
                templates: { header: '<h4>Location Type</h4>' }
            })(instantsearch.widgets.refinementList)({
                container: '#location-list',
                attribute: 'location.type',
            }),

            instantsearch.widgets.hits({
                container: '#hits',
                templates: {
                    item(hit, { html, components }) {
                        const logoUrl = hit.logo || "{{ url_for('static', filename='images/default-org.png') }}";
                        return html`
                            <div class="ais-Hits-item">
                                <a href="/organizations/${hit.objectID}" class="org-hit-link">
                                    <div class="org-hit-header">
                                        <img src="${logoUrl}" alt="${hit.name}" class="org-hit-logo" onerror="this.src='{{ url_for('static', filename='images/default-org.png') }}'">
                                        <div>
                                            <h3 class="org-hit-title">${components.Highlight({ hit, attribute: 'name' })}</h3>
                                            <div class="tags-container" style="margin-top: 0.5rem;">
                                                ${hit.tags && hit.tags.slice(0, 3).map(tag => html`<span class="tag">${tag}</span>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <p>${components.Snippet({ hit, attribute: 'description' })}</p>
                                </a>
                            </div>
                        `;
                    },
                    empty: '<p style="text-align: center; padding: 2rem;">No results found for <q>${search.helper.state.query}</q>.</p>'
                }
            })
        ]);

        search.start();
    });
</script>
{% endblock %}