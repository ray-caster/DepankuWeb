{% extends "base.html" %}

{% block title %}Create Organization - Depanku{% endblock %}
{% block og_title %}Create Organization - Depanku{% endblock %}
{% block og_description %}List your organization and connect with students seeking STEM opportunities.{% endblock %}
{% block twitter_title %}Create Organization - Depanku{% endblock %}
{% block twitter_description %}List your organization and connect with students seeking STEM opportunities.{% endblock %}

{% block content %}
<main class="organization-create-page" id="main-content">
    <!-- Skip Navigation Link -->
    <a href="#form-container" class="skip-link">Skip to organization form</a>

    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="breadcrumb-nav">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}" aria-label="Home">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('organizations.organizations_page') }}" aria-label="Organizations">Organizations</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create Organization</li>
        </ol>
    </nav>

    <section class="organization-form-section" aria-labelledby="form-heading">
        <div class="container">
            <!-- Loading State -->
            <div id="loading-container" class="loading-container" role="status" aria-live="polite">
                <div class="loading-spinner"></div>
                <p class="loading-text">Loading form...</p>
            </div>

            <!-- Form Container -->
            <div id="form-container" class="form-container" style="display: none;">
                <!-- Page Header -->
                <header class="page-header">
                    <div class="header-content">
                        <div class="header-text">
                            <h1 id="form-heading" class="page-title">Create Organization Listing</h1>
                            <p class="page-subtitle">
                                Fill out the details below to list your organization on Depanku. Your submission will be reviewed by our team before going live.
                            </p>
                        </div>
                        <div class="header-help">
                            <button type="button" 
                                    class="btn btn-link btn-sm" 
                                    id="form-help-btn"
                                    aria-label="Get help with the form">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                Need Help?
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Progress Indicator -->
                <div class="form-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Form completion progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">
                        <span class="progress-current">0</span> of <span class="progress-total">5</span> sections completed
                    </div>
                </div>

                <!-- Error Messages -->
                <div id="error-alerts" class="error-alerts" role="alert" aria-live="polite">
                    <!-- Moderation Error Alert -->
                    <div id="moderationErrorAlert" class="alert alert-danger" style="display: none;" role="alert">
                        <div class="alert-header">
                            <h4 id="moderationErrorSummary" class="alert-title" tabindex="0">Content Moderation Issue</h4>
                            <button type="button" 
                                    class="btn-close" 
                                    aria-label="Close moderation alert"
                                    onclick="this.parentElement.parentElement.style.display='none'">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div id="moderationErrorDetails" class="alert-body">
                            <!-- Error details will be populated here -->
                        </div>
                    </div>

                    <!-- General Error Alert -->
                    <div id="generalErrorAlert" class="alert alert-danger" style="display: none;" role="alert">
                        <div class="alert-header">
                            <h4 class="alert-title">Form Error</h4>
                            <button type="button" 
                                    class="btn-close" 
                                    aria-label="Close error alert"
                                    onclick="this.parentElement.parentElement.style.display='none'">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="alert-body">
                            <!-- Error details will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <div id="success-message" class="alert alert-success" style="display: none;" role="alert">
                    <div class="alert-header">
                        <h4 class="alert-title">Success!</h4>
                        <button type="button" 
                                class="btn-close" 
                                aria-label="Close success message"
                                onclick="this.parentElement.parentElement.style.display='none'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="alert-body">
                        Your organization listing has been submitted successfully and is now under review.
                    </div>
                </div>

                <!-- Organization Form -->
                <form id="organizationForm" 
                      class="organization-form" 
                      novalidate 
                      role="form"
                      aria-describedby="form-help">
                    
                    <!-- Form Help Section -->
                    <div id="form-help" class="form-help" style="display: none;">
                        <h3>Form Guidelines</h3>
                        <ul>
                            <li>All fields marked with <span class="required-indicator">*</span> are required</li>
                            <li>Organization descriptions should be comprehensive and informative</li>
                            <li>Tags help students find your organization through search</li>
                            <li>Logo images should be square (minimum 200x200px)</li>
                            <li>All submissions are reviewed by our team before going live</li>
                        </ul>
                        <button type="button" 
                                class="btn btn-secondary" 
                                onclick="document.getElementById('form-help').style.display='none'">
                            Got it
                        </button>
                    </div>

                    <!-- Organization Form Fields -->
                    {% include '_organization_form_fields.html' %}

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="form-actions-left">
                            <button type="button" 
                                    class="btn btn-outline" 
                                    id="save-draft-btn"
                                    aria-label="Save as draft">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                Save Draft
                            </button>
                            <button type="button" 
                                    class="btn btn-outline" 
                                    id="preview-btn"
                                    aria-label="Preview organization listing">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Preview
                            </button>
                        </div>
                        <div class="form-actions-right">
                            <a href="{{ url_for('organizations.organizations_page') }}" 
                               class="btn btn-outline" 
                               aria-label="Cancel and return to organizations">
                                Cancel
                            </a>
                            <button type="submit" 
                                    class="btn btn-primary" 
                                    id="submitBtn"
                                    aria-describedby="submit-help">
                                <span class="btn-text">Submit for Review</span>
                                <span class="btn-loading" style="display: none;">
                                    <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M12 2v10l7 7"></path>
                                    </svg>
                                    Submitting...
                                </span>
                            </button>
                            <div id="submit-help" class="sr-only">
                                Submit your organization listing for review
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Terms and Conditions -->
                <div class="terms-conditions">
                    <h3>Terms and Conditions</h3>
                    <div class="terms-content">
                        <p>By submitting this organization listing, you agree to:</p>
                        <ul>
                            <li>Provide accurate and truthful information about your organization</li>
                            <li>Maintain up-to-date information about your opportunities</li>
                            <li>Respond to student inquiries in a timely manner</li>
                            <li>Follow Depanku's community guidelines and terms of service</li>
                        </ul>
                        <p>All listings are subject to review and may be removed for violations of our policies.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Position Template -->
<template id="positionTemplate">
    <div class="position-card" role="article">
        <div class="position-header">
            <h4 class="position-title">Position #<span class="position-number">1</span></h4>
            <button type="button" 
                    class="btn btn-icon btn-sm remove-position" 
                    aria-label="Remove position">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="position-fields">
            <div class="form-group">
                <label for="position-title" class="form-label">
                    Position Title *
                    <span class="required-indicator" aria-label="Required field">*</span>
                </label>
                <input type="text" 
                       class="form-control position-title" 
                       name="positions[<index>][title]"
                       placeholder="e.g., Software Engineering Intern"
                       aria-required="true"
                       aria-describedby="position-title-help">
                <div id="position-title-help" class="form-text">
                    Enter the official title of the position.
                </div>
                <div class="invalid-feedback" id="position-title-error">Please enter a position title.</div>
            </div>

            <div class="form-group">
                <label for="position-description" class="form-label">Description</label>
                <textarea class="form-control position-description" 
                          name="positions[<index>][description]"
                          rows="3"
                          maxlength="500"
                          aria-describedby="position-desc-help"
                          placeholder="Brief description of the role and responsibilities."></textarea>
                <div id="position-desc-help" class="form-text">
                    Describe what the position entails and what responsibilities the student will have.
                </div>
                <div class="char-counter">
                    <span class="position-desc-count">0</span>/500 characters
                </div>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="position-requirements" class="form-label">Requirements</label>
                        <input type="text" 
                               class="form-control position-requirements" 
                               name="positions[<index>][requirements]"
                               placeholder="e.g., Python, HTML, CSS"
                               aria-describedby="position-req-help">
                        <div id="position-req-help" class="form-text">
                            Comma-separated list of required skills or qualifications.
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="position-link" class="form-label">Application Link</label>
                        <input type="url" 
                               class="form-control position-link" 
                               name="positions[<index>][link]"
                               placeholder="https://example.com/apply"
                               aria-describedby="position-link-help">
                        <div id="position-link-help" class="form-text">
                            Direct link to the application page or job posting.
                        </div>
                        <div class="invalid-feedback" id="position-link-error">Please enter a valid URL.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">Organization Creation Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close help modal"></button>
            </div>
            <div class="modal-body">
                <div class="help-content">
                    <h6>Getting Started</h6>
                    <p>Welcome to Depanku's organization creation form. This guide will help you create an effective listing that attracts qualified students.</p>
                    
                    <h6>Best Practices</h6>
                    <ul>
                        <li><strong>Organization Name:</strong> Use your official organization name as it appears on legal documents</li>
                        <li><strong>Description:</strong> Be comprehensive and highlight your mission, values, and impact</li>
                        <li><strong>Tags:</strong> Include relevant keywords students would search for (e.g., "STEM", "coding", "research")</li>
                        <li><strong>Logo:</strong> Use a high-quality, square logo that represents your brand</li>
                        <li><strong>Positions:</strong> List specific opportunities with clear requirements and application processes</li>
                    </ul>

                    <h6>Tips for Success</h6>
                    <ul>
                        <li>Be specific about eligibility requirements (age, education level, skills)</li>
                        <li>Provide clear application instructions and deadlines</li>
                        <li>Include contact information for student inquiries</li>
                        <li>Update your listing regularly with new opportunities</li>
                    </ul>

                    <h6>Review Process</h6>
                    <p>All organization listings are reviewed by our team within 24-48 hours. We check for:</p>
                    <ul>
                        <li>Accuracy and completeness of information</li>
                        <li>Appropriate content and language</li>
                        <li>Legitimacy of the organization</li>
                        <li>Quality of opportunities offered</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="contact-support-btn">Contact Support</button>
            </div>
        </div>
    </div>
</div>

<!-- Structured Data for Organization Creation -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Create Organization - Depanku",
    "description": "Form for creating organization listings on Depanku platform",
    "url": "{{ canonical_url|default('https://depanku.com' + request.path) }}",
    "author": {
        "@type": "Organization",
        "name": "Depanku"
    },
    "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "{{ canonical_url|default('https://depanku.com') }}"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Organizations",
                "item": "{{ canonical_url|default('https://depanku.com/organizations') }}"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "Create Organization",
                "item": "{{ canonical_url|default('https://depanku.com' + request.path) }}"
            }
        ]
    },
    "mainEntity": {
        "@type": "Form",
        "name": "Organization Registration Form",
        "action": "/api/organizations",
        "method": "POST",
        "targetDescription": "Create organization listings on Depanku platform",
        "formElement": {
            "@type": "Thing",
            "name": "Organization Information",
            "description": "Basic information about the organization including name, description, contact details, and available positions"
        }
    }
}
</script>

{% block scripts %}
<script src="{{ url_for('static', filename='js/organization_form.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize form for create mode
        initializeFormForCreate();
        
        // Form validation and submission
        const form = document.getElementById('organizationForm');
        const submitBtn = document.getElementById('submitBtn');
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const previewBtn = document.getElementById('preview-btn');
        const formHelpBtn = document.getElementById('form-help-btn');
        const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        
        // ARIA Live Region for Dynamic Updates
        const ariaLiveRegion = document.createElement('div');
        ariaLiveRegion.className = 'sr-only';
        ariaLiveRegion.setAttribute('aria-live', 'polite');
        ariaLiveRegion.setAttribute('aria-atomic', 'true');
        document.body.appendChild(ariaLiveRegion);
        
        function announceToScreenReader(message) {
            ariaLiveRegion.textContent = message;
            setTimeout(() => {
                ariaLiveRegion.textContent = '';
            }, 1000);
        }
        
        // Form help button
        formHelpBtn.addEventListener('click', () => {
            helpModal.show();
            announceToScreenReader('Help modal opened');
        });
        
        // Contact support button
        document.getElementById('contact-support-btn').addEventListener('click', () => {
            helpModal.hide();
            // In a real implementation, this would open a contact form or redirect to support
            window.location.href = '/contact';
        });
        
        // Save draft functionality
        saveDraftBtn.addEventListener('click', async () => {
            try {
                // Simulate saving draft
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Show success message
                const successAlert = document.getElementById('success-message');
                successAlert.querySelector('.alert-body').textContent = 'Draft saved successfully!';
                successAlert.style.display = 'block';
                
                announceToScreenReader('Draft saved successfully');
                
            } catch (error) {
                console.error('Failed to save draft:', error);
                announceToScreenReader('Failed to save draft');
            }
        });
        
        // Preview functionality
        previewBtn.addEventListener('click', () => {
            // In a real implementation, this would open a preview page
            alert('Preview functionality would open a new tab with the organization listing preview');
        });
        
        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                announceToScreenReader('Please fix the errors in the form');
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.querySelector('.btn-text').style.display = 'none';
            submitBtn.querySelector('.btn-loading').style.display = 'block';
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Show success message
                const successAlert = document.getElementById('success-message');
                successAlert.querySelector('.alert-body').textContent = 'Your organization listing has been submitted successfully and is now under review.';
                successAlert.style.display = 'block';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                announceToScreenReader('Organization listing submitted successfully');
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = '{{ url_for("organizations.organizations_page") }}';
                }, 3000);
                
            } catch (error) {
                console.error('Failed to submit form:', error);
                
                // Show error message
                const errorAlert = document.getElementById('generalErrorAlert');
                errorAlert.querySelector('.alert-body').textContent = 'Failed to submit organization listing. Please try again.';
                errorAlert.style.display = 'block';
                
                announceToScreenReader('Failed to submit organization listing');
            } finally {
                submitBtn.disabled = false;
                submitBtn.querySelector('.btn-text').style.display = 'block';
                submitBtn.querySelector('.btn-loading').style.display = 'none';
            }
        });
        
        // Form validation function
        function validateForm() {
            let isValid = true;
            
            // Validate organization name
            const nameInput = document.getElementById('name');
            if (!nameInput.value.trim()) {
                nameInput.classList.add('is-invalid');
                isValid = false;
            } else {
                nameInput.classList.remove('is-invalid');
            }
            
            // Validate description
            const descriptionInput = document.getElementById('description');
            if (!descriptionInput.value.trim()) {
                descriptionInput.classList.add('is-invalid');
                isValid = false;
            } else {
                descriptionInput.classList.remove('is-invalid');
            }
            
            // Validate category
            const categorySelect = document.getElementById('category');
            if (!categorySelect.value) {
                categorySelect.classList.add('is-invalid');
                isValid = false;
            } else {
                categorySelect.classList.remove('is-invalid');
            }
            
            // Validate website if provided
            const websiteInput = document.getElementById('website');
            if (websiteInput.value && !isValidUrl(websiteInput.value)) {
                websiteInput.classList.add('is-invalid');
                isValid = false;
            } else {
                websiteInput.classList.remove('is-invalid');
            }
            
            // Validate contact email if provided
            const contactEmailInput = document.getElementById('contactEmail');
            if (contactEmailInput.value && !isValidEmail(contactEmailInput.value)) {
                contactEmailInput.classList.add('is-invalid');
                isValid = false;
            } else {
                contactEmailInput.classList.remove('is-invalid');
            }
            
            // Validate logo URL if provided
            const logoInput = document.getElementById('logo');
            if (logoInput.value && !isValidUrl(logoInput.value)) {
                logoInput.classList.add('is-invalid');
                isValid = false;
            } else {
                logoInput.classList.remove('is-invalid');
            }
            
            return isValid;
        }
        
        // URL validation helper
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Real-time validation
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.classList.add('is-invalid');
                } else if (this.type === 'url' && this.value && !isValidUrl(this.value)) {
                    this.classList.add('is-invalid');
                } else if (this.type === 'email' && this.value && !isValidEmail(this.value)) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to submit form
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                if (helpModal._isShown) {
                    helpModal.hide();
                }
            }
        });
    });
</script>
{% endblock %}